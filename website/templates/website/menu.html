{% extends 'website/base.html' %}
{% load static %}

{% block css %}
<style>

.text-on-line {
   width: 100%; 
   text-align: center; 
   border-bottom: 1px solid #FF5400; 
   line-height: 0.1em;
   margin: 20px 0 30px; 
} 

/* for the heading line with text on it for category */
.text-on-line span { 
    background:#fff; 
    padding:0 10px; 
    color: #FF5400;
}



/*  hovering effects */
.menu_item_hover .btn_order{
    /* visibility: hidden; */
    border:solid 1px #FF5400;
        
}
.btn_order:focus{
    background-color: yellowgreen;
}

.menu_item_hover:hover{
    /* border-radius: 4px; */
    /* border: 1px solid green; */
    box-shadow: 0px 8px 12px 5px rgba(171,160,160,0.48);
    -webkit-box-shadow: 0px 8px 12px 5px rgba(171,160,160,0.48);
    -moz-box-shadow: 0px 8px 12px 5px rgba(171,160,160,0.48);
}

.in-cart-item-counter{
    /* visibility: hidden; */
    display: none;
}

.menu_item_hover:hover .btn_order{
    visibility: visible;
    color: #FF5400;
    background-color: wheat;
    border: 1px solid #FF5400;
   
} 
.menu_item_hover:hover .in-cart-item-counter{
    visibility: visible;
    display: inline;
    position: absolute;
}

.btn_order{
    color: #FF5400;
}

.menu_item_hover:hover .btn_order:hover{
    background-color: #FF5400;
    color:white;
}

/* for fab btn */
.btn-group-fab {
  position: fixed;
  width: 50px;
  height: auto;
  right: 20px; bottom: 20px;
}
.btn-group-fab div {
  position: relative; width: 100%;
  height: auto;
}
.btn-group-fab .btn {
  position: absolute;
  bottom: 0;
  border-radius: 50%;
  display: block;
  margin-bottom: 4px;
  width: 40px; height: 40px;
  margin: 4px auto;
}
.btn-group-fab .btn-main {
  width: 50px; height: 50px;
  right: 50%; margin-right: -25px;
  z-index: 9;
}

.btn-order{
    border: solid 1px #FF5400;
    margin: 0px;
    color: #FF5400;
    font-weight: bold;
}
.menu_item_hover:hover .btn-order:hover{
    background-color: #FF5400;
    color:white;
}

.menu-links{
    border: solid 1px #FFF;
}
/* .menu-links:hover{background-color: #FFF;} */

.checked{color: #FF5400;}


</style>

{% endblock css %}
{% block content %}

<!-- this is the sticky  -->
<nav class="navbar navbar-expand-lg sticky-top" style="background-color: #FF5400;">
    <div class="container-fluid">
        <ul class="navbar-nav mx-auto my-lg-0" style="flex-direction: row;">
        {% for category in object_list %}
          <li class=" mx-2 px-2 py-0 menu-links ">
            <a class="nav-link text-white title-fonts" style="padding-bottom: 0px;" href="#{{category}}">
                <h2 class=" title-fonts"><span>{{category|title}}</span></h2>
            </a>
          </li> 
        {% endfor %}
        </ul>
    </div>
</nav>

<div class="container">
    <div class="row">
        {% for category in object_list %}
            <h2 class="text-on-line title-fonts" id="{{category}}"><span>{{category|title}}</span></h2>
            {% for obj in category.menu_set.all %}
            {%  if category.name == "Drinks" %}
                <div class="col-6 col-sm-6 col-md-6 col-lg-2 py-3">
                    {% else %}
                <div class="col-6 col-md-6 col-lg-4 px-3 py-3">
                    {% endif %}
                    <div class="menu_item_hover mb-3 pb-2 text-center" data-id="{{obj.pk}}" id="{{obj.pk}}">
                        <img class="mx-auto d-block" id="{{obj.id}}" src="{{obj.photo.url}}" style="width: 100%;" alt="">
                        <h4 class="text-center title-fonts"><span class="name title-fonts">{{obj.name|title}}</span> </h4>
                        {% comment %} <p class="text-center body-text">{{obj.description|capfirst}}</p>{% endcomment%}
                        <span class="fa fa-star checked"></span>
                        <span class="fa fa-star checked"></span>
                        <span class="fa fa-star checked"></span>
                        <span class="fa fa-star checked"></span>
                        <span class="fa fa-star"></span>
                        <p class="text-center"><b class="price title-fonts"> {{obj.price}} AED </b></p>
                        <p class="title-fonts">
                    {% if not obj.available  %}
                        <h4 class="btn rounded-0 btn-order mx-0 title-fonts" style="border:solid 1px #FF5400"> Not Available </h4>
                    {% else %}
                        {%  if category.name == "Drinks" %}
                        <span class="btn d-none rounded-0 decrement-item btn-order mx-0 title-fonts" onClick='decreaseCount(event, this)'  data-id="{{obj.pk}}">-</span><span data-id="{{obj.pk}}" class="btn btn_order rounded-0 title-fonts">Add To Cart</span><span class="btn d-none title-fonts rounded-0 increment-item btn-order" onClick='increaseCount(event, this)' data-id="{{obj.pk}}">+</span>
                        {% else %}
                        <span class="btn d-none rounded-0 decrement-item btn-order mx-0 title-fonts" onClick='decreaseCount(event, this)' data-id="{{obj.pk}}">-</span><span data-id="{{obj.pk}}"  class="btn btn_order rounded-0 title-fonts">Add To Cart</span><span class="btn d-none title-fonts rounded-0 increment-item btn-order" onClick='increaseCount(event, this)' data-id="{{obj.pk}}">+</span>
                        {% endif %}
                    {% endif %}
                        </p>
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
        <div class="btn-group-fab shopping-cart" style="z-index: 1000;" role="group" aria-label="FAB Menu">
            <div >
            <a href="{% url 'website:cart_view' %}">
                <button class="btn btn-main px-auto" style="height: 70px; width: 70px; background-color: #FF5400; color: #fff;"  title="Cart"> 
                <h2 id="order_counter" class="pt-1">0</h2>
                <!-- <span class="iconify" data-icon="mdi-light:cart" style="color: white;" data-width="30" data-height="35"></span> -->
                </button>
            </a>
            </div>
        </div>
    </div>
</div>
</div>

{% endblock content %}

{% block js %}

<script src="{% static 'js/scripts.js' %}"></script>

<script>
// load the menu item in cart counter labal
$(document).ready(function(){
    if(localStorage.getItem('order')){
      var orders = localStorage.getItem('order');
      if(orders.search(";") == -1){
      // not ; that means one order
    
      var obj_one = JSON.parse(orders);
      // loop through cards and check ids
      $('.menu_item_hover').each(function(){
            var card_id = $(this).attr('data-id');
            if(obj_one.id == card_id){
              set_label(card_id, obj_one.quantity);
            }
            // alert( obj_one.id)
        });
    }else{
      // found a ; that means two order or more
      var obj_arr = orders.split(";");
      for(var i in obj_arr){
        var one = JSON.parse(obj_arr[i]);
        $('.menu_item_hover').each(function(){
            var card_id = $(this).attr('data-id');
            if(one.id == card_id){
               set_label(card_id, one.quantity);
            }
            // alert( obj_one.id)
        });
      }
    }
    }
});


function increaseCount(a, b) {
  var input = b.previousElementSibling;
  var value = parseInt(input.textContent, 10); 
  value = isNaN(value)? 0 : value;
  value ++;
  var id_of_order = input.getAttribute('data-id');
  update_order_quantity(id_of_order, value);
  input.textContent = value;
}

function decreaseCount(a, b) {
  var input = b.nextElementSibling;
  var value = parseInt(input.textContent, 10); 
  if(value == 1){
    delete_order(parseInt(input.getAttribute('data-id')))
    input.textContent = "Add To Cart"
    b.classList.add("d-none");
    b.nextElementSibling.nextElementSibling.classList.add("d-none");
    Order_counter()
  }
  if (value > 1) {
    value = isNaN(value)? 0 : value;
    value --;
    var id_of_order = input.getAttribute('data-id');
    update_order_quantity(id_of_order, value);
    input.textContent = value;
  }
}

function set_label(id, val){
    $("#"+id).find('.btn_order').text(val).css({"padding":"auto 4em"});
    $("#"+id).find('.decrement-item').removeClass('d-none');
    $("#"+id).find('.increment-item').removeClass('d-none');
}
function update_order_quantity(order_id, quantity){
  if(localStorage.getItem("order")){
    var orders = localStorage.getItem("order");
    if(orders.search(";") == -1){
      // not ; that means one order
      var obj_one = JSON.parse(orders);
      // now cheeck the ids
      if(obj_one.id == order_id){
        obj_one.quantity = quantity;
        Update_order(orders, 0, obj_one, true);
        return ;
      }
    }else{
      // found a ; that means two order or more
      var obj_arr = orders.split(";");
      for(var i in obj_arr){
        // check the orders
        var one = JSON.parse(obj_arr[i]);
        if(one.id == order_id){
          one.quantity  = quantity;
          Update_order(obj_arr, i, one, false);
          return
        }
      }
    }
  }
}

function Update_order(obj_all, index, update, one_item){
  var on='';
  var size  = Object.keys(obj_all).length;
    for(var i in obj_all){
      if(i == index){
        if(i == 0){
          on +=JSON.stringify(update);
          if(one_item == true){
            break;
          }
        }else{
          on +=";"+JSON.stringify(update);
        }
      }else{
        if(i == 0){
          on += obj_all[i];
          if(one_item == true){
            break;
          }
        }else{
          on += ";"+obj_all[i];
        }
      }
    }
  localStorage.removeItem("order");
  localStorage.setItem("order", on);
}

function delete_order(id){
  if (localStorage.getItem("order")){
    var orders = localStorage.getItem("order");
    if(orders.search(";") == -1){
      var obj_order = JSON.parse(orders);
      if( obj_order.id == id){
        // ids are matched, remove order
        localStorage.removeItem("order");
        Order_counter();
      }
    }else{
    // more then one order
      var obj_order_arr = orders.split(";");
      var new_order ='';
      for(var i in obj_order_arr){
        // check the orders
        var one = JSON.parse(obj_order_arr[i]);
        if(one.id == id){
          continue;
        }else{
            new_order += ";"+JSON.stringify(one);
        }
      }
      new_order = new_order.substring(1)
      localStorage.removeItem("order");
      localStorage.setItem("order", new_order);
    }
  }  
}

$(document).ready(function(){
    $('.btn_order').each(function(){
        $(this).click(function(){
            var obj_id = $(this).attr("data-id");
            var img = document.getElementById(obj_id);
            // change thee image to text
            // imgData = getBase64Image(img);
            var obj_name = $(this).closest('.menu_item_hover').find('.name').text();
            var obj_price = $(this).closest('.menu_item_hover').find('.price').text();
            var obj_order = {id:obj_id,name:obj_name, price:obj_price, quantity:1}
            // put to local storage function
            To_local_Storage(obj_order);

            // set label
            var labal = parseInt($(this).text());
            labal >=1 ? set_label(obj_id, labal+1) : set_label(obj_id,1);
           
        }); // end of clic
    }); //end of each function
});

// img to textDATA
function getBase64Image(img) {
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    var dataURL = canvas.toDataURL("image/png");
    return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
}

function To_local_Storage(obj){
// check if we localstorage has got order already. 
    if(localStorage.getItem("order")){   
        var orders = localStorage.getItem("order");
        // check if it have ";"
        if(orders.search(";") == -1){
            // no match is found that means that order is one
            // change it to obj
            var obj_one = JSON.parse(orders);
            // now cheeck the ids
            if(obj_one.id == obj.id){
                Update_order(obj_arr, i, one);
                return ;
            }else{
                add_order(obj);
            }
        }else{
            // so the order is more then one and we split and check
            var obj_arr = orders.split(";");
            for(var i in obj_arr){
                // check the orders
                var one = JSON.parse(obj_arr[i]);
                if(one.id == obj.id){
                    one.quantity += 1;
                    Update_order(obj_arr, i, one);
                    return
                }
            }
            add_order(obj);
        }  // end of ";" search
    }else{
        one_order(obj);
        Order_counter();
    } // end of else for if of local storage
} // eend of function

function add_order(obj){
    // localStorage
    var local_storagee_orders = localStorage.getItem("order");
    local_storagee_orders += ";"+JSON.stringify(obj); 
    localStorage.setItem("order", local_storagee_orders);
    Order_counter();
}

function one_order(obj){
    var obj_local = JSON.stringify(obj);
    localStorage.setItem("order", obj_local);
    Order_counter();
}

function Order_counter(){
    if(localStorage.getItem("order")){
        let order_counter = localStorage.getItem("order").split(";");
        $("#order_counter").text(order_counter.length)
    }else{ $('#order_counter').text(0)}
}
// load the order counter on load
$(document).ready(function(){
    if(localStorage.getItem("order")){
      let order_counter = localStorage.getItem("order").split(";");
      $("#order_counter").text(order_counter.length)
    }else{ $('#order_counter').text(0) }
});

</script>
{% endblock js %}



